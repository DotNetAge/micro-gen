package persistence

import (
	"context"
	"sync"

	"{{ project_name }}/internal/entity/projection"
)

// Memory{{ aggregate_name }}Repository 内存实现的{{ aggregate_name }}读模型存储适配器
type Memory{{ aggregate_name }}Repository struct {
	mu     sync.RWMutex
	models map[string]*{{ read_model_name }} // id -> model
}

// NewMemory{{ aggregate_name }}Repository 创建内存存储适配器
func NewMemory{{ aggregate_name }}Repository() *Memory{{ aggregate_name }}Repository {
	return &Memory{{ aggregate_name }}Repository{
		models: make(map[string]*{{ read_model_name }}),
	}
}

// Save 保存读模型到内存
func (r *Memory{{ aggregate_name }}Repository) Save(ctx context.Context, model *{{ read_model_name }}) error {
	r.mu.Lock()
	defer r.mu.Unlock()
	
	r.models[model.GetID()] = model
	return nil
}

// FindByID 根据ID查找读模型
func (r *Memory{{ aggregate_name }}Repository) FindByID(ctx context.Context, id string) (*{{ read_model_name }}, error) {
	r.mu.RLock()
	defer r.mu.RUnlock()
	
	if model, ok := r.models[id]; ok {
		return model, nil
	}
	
	return nil, projection.ErrReadModelNotFound
}

// FindAll 查找所有读模型
func (r *Memory{{ aggregate_name }}Repository) FindAll(ctx context.Context) ([]*{{ read_model_name }}, error) {
	r.mu.RLock()
	defer r.mu.RUnlock()
	
	var result []*{{ read_model_name }}
	for _, model := range r.models {
		result = append(result, model)
	}
	
	return result, nil
}

// Delete 删除读模型
func (r *Memory{{ aggregate_name }}Repository) Delete(ctx context.Context, id string) error {
	r.mu.Lock()
	defer r.mu.Unlock()
	
	delete(r.models, id)
	return nil
}